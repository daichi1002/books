# 現役 IT 企業で働くエンジニアが AWS ECS の基礎から応用までカバー。コンテナを使ったアプリケーション開発の基礎から応用まで全て身につけます。

## コンテナによるアプリケーション開発の基本

### AWS ECS とは

Amazon ECS は完全に管理されたコンテナオーケストレーションサービスであり、コンテナ化されたアプリケーションを簡単にデプロイ、管理、およびスケールするのに役立ちます。

#### コンテナとは？

貨物船に使われるコンテナをイメージ。アプリケーションとそれに必要な周辺ソフトウェアをパッケージ化したもの。

#### スケーリングとは？

システム利用者の増大に応じて、システム規模を拡大縮小すること。スケーラビリティ＝スケールのしやすさ。

### ECS の基本構造

クラスター：コンテナを配置する複数の EC2、Fargate、外部インスタンスで構成される要素。クラスター内には、複数のタスクが配置され、それぞれが独自のコンテナを実行。

サービス：クラスター内で実行中のタスクを管理する。

タスク定義：タスクを構成するコンテナ群の定義。CPU やメモリをどのように割り当てるかなど。

タスク：タスク定義に基づいて起動するコンテナの集まりのこと。

## AWS におけるネットワーク入門

### AWS VPC とは？

AWS 上に自由に作成できる専用の仮想ネットワーク環境。この VPC の上に自分たちのデータベースやアプリサーバーを配置していく。土台になる空間のようなイメージ。

### Subnet とは？

VPC 上の IP アドレス範囲を区切ったネットワーク空間。VPC の中に複数作成することができる。VPC = 国、Subnet = 地区のようなイメージ。

#### プライベート IP アドレス

##### プライベート IP アドレスの範囲

`10.0.0.1` - `10.255.255.255`、
`172.16.0.0` - `172.31.255.255`、
`192.168.0.0` - `192.168.255.255`

##### グローバル IP アドレス

インターネット上で一意なアドレス。このアドレスを使用して、世界中の機器と直接通信することができる。

##### プライベート IP アドレス

特定のネットワーク内でのみ使用されるアドレス。ネットワークが異なれば IP アドレスが重複していても問題なく利用できる。

#### CIDR

ネットワークのアドレスとネットワーク部の範囲を表す記法。利用できる IP アドレス範囲がわかる。`10.0.0.0/28`
![alt text](<スクリーンショット 2024-10-31 8.21.07.png>)

### パブリックサブネット

インターネットに直接アクセスできるサブネット。サーバーはグローバル IP アドレスを持つことで外部からアクセスできる。

### プライベートサブネット

インターネットに直接アクセスできないサブネット。

### ルートテーブル

ルートテーブルとは、VPC 内（サブネット内）の通信を振り分けるルールの一覧こと。1 つのサブネットに対して、1 つのルートテーブルと関連付ける。

### インターネットゲートウェイ

「VPC という閉じられた世界」から「膨大なインターネットの世界へ」とつなぐ門としての役割を担っている。デフォルトのルートテーブルでは、VPC 内しかルーティングが向いていない（プライベートサブネット）。インターネットと直接接続できる状態にできるもの。

### セキュリティグループ

VPN のサーバーなどに紐付けて通信を制御するための仮想ファイヤーウォール。アウトバウンド（出ていく通信）とインバウンド（入ってくる通信）のルールを定義してアクセスを管理する。

1. ホワイトリスト方式：インバウンド・アウトバンドルールに記載のないものは全て不許可
2. 高い柔軟性：許可する対象は IP アドレスのほか、特定のセキュリティグループを持つリソースで指定も可能
3. 即時反映：ルールの変更は全ての関連するインスタンスに即時反映

## Blue/Green デプロイ

Blue/Green デプロイは、新旧のバージョンを並行稼働させることで、ダウンタイムを最小限に抑え、リスクを管理しやすくする方法。AWS CodeDeploy を使って実装する。

1. 新しいアプリのコンテナ(Green)をデプロイする
2. 新しいアプリのコンテナ(Green)が正しく動作することを確認する
3. 新しいアプリのコンテナ(Green)にユーザーからの通信を切り替える
4. 古いアプリのコンテナ(Blue)を削除する

|      | Blue/Green デプロイ                                            | ローリングアップデート                           |
| ---- | -------------------------------------------------------------- | ------------------------------------------------ |
| Good | ダウンタイムの最小化<br>迅速なロールバック<br>安全なテスト環境 | 段階的なデプロイメント<br>リソースの効率的な活用 |
| Bad  | コストの増加<br>管理の複雑さ                                   | ロールバックの複雑さ                             |

メモ

- ロードバランサーで listener と target group を作成する
- security group で blue のアプリにはどのユーザーからもアクセスできるように設定し、green のアプリには開発者からの IP アドレスしかアクセスできないように制限をかける
- ヘルスチェックで green のコンテナが正常に起動・動作しているかを確認する

参考資料：https://cmc-japan.co.jp/blog/%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%A8%E3%81%AF/

#### CodeDeploy のデプロイ設定

- CodeDeployDefault.ECS AllAtOnce:
  すべてのトラフィックを Green のコンテナに一度に移行する

- CodeDeployDefault.ECSLinear10PercentEvery1Minutes :
  1 分ごとに 10%ずつ を Green へのトラフィックを増やす

- CodeDeployDefault.ECSLinear10PercentEvery3Minutes :
  3 分ごとに 10%ずつ を Green へのトラフィックを増やす

- CodeDeployDefault.ECSCanary10Percent5Minutes:
  最初に 10% のトラフィックを Green へ流し、残りの 90 パーセントは 5 分後に流す

- CodeDeployDefault.ECSCanary10Percent15Minutes :
  最初に 10% のトラフィックを Green へ流し、残りの 90 パーセントは 15 分後に流す

## ECS と CI/CD パイプライン

#### Open ID Connect とは

ユーザー認証を簡略化するためのプロトコル。ユーザーがログインする際に別のシライできるサービス（Google や Facebook など）のアカウントを使用できるようにする。

ECS のアプリをアップデート = Task 定義を更新し、デプロイする

## オートスケーリング

### スケーリングとは

システム利用者の増大に応じて、システム規模を拡大縮小すること。スケーラビリティ=スケールのしやすさ<br>
トラフィックが多い -> コンテナ増<br>
トラフィックが少ない -> コンテナ減

#### スケーリングの種類

##### 水平スケーリング

- サーバーの数を増やす・減らす
- 1 つ 1 つの処理は軽いが、量が多いケースが得意(EC site など)
- ECS Autoscaling は水平スケーリングのみをサポートしている

##### 垂直スケーリング

- サーバーの性能をアップする・ダウンする
- 大量の CPU やメモリが必要な複雑な処理が得意
- 物理的にスケールアップの上限がある
- スケールアップ・スケールダウンする場合に一度サーバーを停止する必要がある（置き換え先が必要）

### ECS がサポートする水平スケーリングの種類

#### ステップスケーリングポリシー

CPU やメモリ使用率に応じて定義されたコンテナの数に合わせる
カスタマイズ性は高いが、ユーザーが管理する手間がかかる。

#### ターゲット追跡スケーリングポリシー

CPU やメモリのターゲット使用率になるようにコンテナの数を増減させる
基本的にはこちらを使用するケースが多い。

### k6

負荷を与えるためのツール。オープンソースで無料で使える。<br>
[負荷テストツール「k6」入門](https://zenn.dev/pharmax/articles/98ed49994cdaf2)

## ECS における状態管理

## マイクロサービスアーキテクチャ入門
